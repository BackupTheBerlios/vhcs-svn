HOWTO Update VHCS 2.4.6.2 to VHCS 2.4.7 (English)

-------------------
General Information
-------------------

1) Download the newest VHCS2 release :
// Only available for the final ;)
tangra: # wget http://heanet.dl.sourceforge.net/sourceforge/vhcs/vhcs2.4.7.tar.bz2

2) Turn off the VHCS Daemon:

tangra: # /etc/init.d/vhcs2_daemon stop

3) Make a backup of the current VHCS files of your system:

tangra: # mv /var/www/vhcs2/gui /var/www/vhcs2/gui_bcp_yyyymmdd
tangra: # cp -R /var/www/vhcs2/engine /var/www/vhcs2/engine_bcp_yyyymmdd

4) Unpack the downloaded archive :

tangra: #tar -xjf vhcs2.4.7.tar.bz2


-------------------
vhcs2.conf Update
-------------------

1) Lines to add:

Search for MTA_SASLDB_FILE and add lines. The result should looks like this:

MTA_SASLDB_FILE = /var/spool/postfix/etc/sasldb2

ETC_SASLDB_FILE = /etc/sasldb2

CMD_SASLDB_LISTUSERS2 = /usr/sbin/sasldblistusers2

CMD_SASLDB_PASSWD2 = /usr/sbin/saslpasswd2


Search for MAIL_TRAFF_LOG and add lines. The result should looks like this:

MAIL_TRAFF_LOG = mail.log

MAIL_LOG_INC_AMAVIS = 0

PREV_TRAFF_LOG_MAX_SIZE = 10485760

QUOTA_ROOT_DIR = /var/www/vhcs2/engine/quota


2) Set your default settings for traffic counting:

If you are using AMAVIS and SPAMASSASSIN change

MAIL_LOG_INC_AMAVIS = 0

to 

MAIL_LOG_INC_AMAVIS = 1


3) Set permissions for vhcs2.conf (needed for autoresponder) :

tangra: # chmod 0644 /etc/vhcs2/vhcs2.conf


-------------------
Engine Update
-------------------

1) Copy the new engine files

tangra: # cp -a /mydir/engine/ /var/www/vhcs2/

2) Copy your crypt key from the old /engine_bcp_yyyymmdd/vhcs2-db-keys.pl to /engine/vhcs2-db-keys.pl and
	from the old /gui_bcp_yyyymmdd/include/vhcs2-db-keys.php to /gui/include/vhcs2-db-keys.php.

tangra: # cp /var/www/vhcs2/engine_bcp_yyyymmdd/vhcs2-db-keys.pl /var/www/vhcs2/engine/vhcs2-db-keys.pl
tangra: # cp /var/www/vhcs2/gui_bcp_yyyymmdd/include/vhcs2-db-keys.php /var/www/vhcs2/gui/include/vhcs2-db-keys.php

3) changes for vhcs2-arpl-msgr

tangra: # cp /var/www/vhcs2/engine/vhcs2-db-keys.pl /var/www/vhcs2/engine/messager/vhcs2-db-keys.pl

4) We changed sasldb2 management for the postfix chroot.
	
So postfix had his own file in /var/spool/postfix/etc/sasldb2
and the system file is located in /etc/sasldb2. 

If you DIDN'T have other apps running that are using /etc/sasldb2 you have to run
following command:

tangra: # cp /var/spool/postfix/etc/sasldb2 /etc/sasldb2

If you DID have other apps running that are using /etc/sasldb2 you don't have to run
any command


Backup Engine Update
-------------------

1) Remove old file if they already exists:

tangra: # rm /var/www/vhcs2/engine/tools/vhcs2-backup-all

2) Check and maybe change the crontab line for the backup

if line looks like: 

/var/www/vhcs2/engine/tools/vhcs2-backup-all yes &>/var/log/vhcs2/vhcs2-backup-all-mngr.log

change it too:

/var/www/vhcs2/engine/backup/vhcs2-backup-all yes &>/var/log/vhcs2/vhcs2-backup-all-mngr.log


Traffic Engine Update
-------------------

1) Delete old log analyzing tool:

tangra: # rm /usr/sbin/pflogsumm.pl
tangra: # rm -R /var/www/vhcs2/engine/traffic/pflogsumm-1.0.10
tangra: # rm -R /var/www/vhcs2/engine/traffic/pflogsumm-1.1.0

2) Changes specially for SuSE:

tangra: # mv /var/www/vhcs2/engine/traffic/vhcs2-vrl-traff /var/www/vhcs2/engine/traffic/vhcs2-vrl-traff-DEBIAN
tangra: # mv /var/www/vhcs2/engine/traffic/vhcs2-vrl-traff-SUSE /var/www/vhcs2/engine/traffic/vhcs2-vrl-traff

3) Delete backup-lock file if it exit:

tangra: # rm /tmp/vhcs2-backup-all.lock


Engine Templates Update
-------------------

Update apache template part for subdomain errorpages:

tangra: # cp /mydir/configs/apache/parts/sub_entry.tpl /etc/vhcs2/apache/parts/sub_entry.tpl


Finish Engine Updates
-------------------

1) Set correct engine permissions:

tangra: # /var/www/vhcs2/engine/setup/set-engine-permissions.sh


-------------------
GUI Update
-------------------

1) Set correct gui permissions:

tangra: # /var/www/vhcs2/engine/setup/set-gui-permissions.sh

2) Password reminder:

install GD library:
tangra: # apt-get install php4-gd

Apache neustarten:
tangra: # apache2ctl graceful

3) Hostingplan changes: 

in the /vaw/www/vhcs2/gui/include/vhcs-lib.php

Search for $cfg['HOSTING_PLANS_LEVEL'] you have this options:

'admin' => hosting plans are available only in admin level, reseller can not make custom changes
'reseller' => hosting plans are available only in reseller level

!!!Attention: If you have already hostingplans in reseller area you should turn this option to
	'reseller' !!!		

-------------------
Database Update
-------------------

Updated language tables could be updated by importing the languages.sql 
For example with phpmyadmin or over commandline. File is located in:

configs/database/languages.sql

Change status for all mail-addresses because of rebuild SASLDB2 and MD5 passwords:

UPDATE `vhcs2`.`mail_users` SET `status` = 'change' WHERE `status` = 'ok';

Change status for all subdomains because of rebuild apache conf for subdomains:

UPDATE `vhcs2`.`subdomain` SET `status` = 'change' WHERE `status` = 'ok';

Update field settings:

ALTER TABLE `hosting_plans` 
ADD `price` decimal(10,2) NOT NULL default '0.00',
ADD `setup_fee` decimal(10,2) NOT NULL default '0.00';

ALTER TABLE `admin` ADD `uniqkey` varchar(255);

-------------------
Finish update
-------------------

1) Now you should execute the VHCS engine manually, because users/customers may have made system changes during your update operation
   This could take a moment!

tangra: # /var/www/vhcs2/engine/vhcs2-rqst-mngr

2) Now you can start the VHCS daemon

tangra: # /etc/init.d/vhcs2_daemon start


VHCS is successfully updated !
